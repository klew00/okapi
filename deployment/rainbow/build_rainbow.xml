<?xml version="1.0"?> 
<project name="rainbow" default="all" basedir="."> 

	<!-- Get the version information to use from file -->
	<property file="../shared/release.properties" />
	<property name="rainbowStamp" value="${rainbowVersion}${releaseInfo}" />
	
	<!-- Guess the platform if this build file is not called with the platform already set -->
	<condition property="platform" value="win32-x86">
		<os family="windows"/>
	</condition>
	<condition property="platform" value="carbon-macosx">
		<os family="mac"/>
	</condition>
	<condition property="platform" value="gtk2-linux-x86">
		<os name="Linux" arch="x86"/>
	</condition>
	<condition property="platform" value="gtk2-linux-x86_64">
		<os name="Linux" arch="x86_64"/>
	</condition>

	<!-- Set flags for what dstribution is being built -->
	<condition property="building-windows">
		<equals arg1="${platform}" arg2="win32-x86"/>
	</condition>
	<condition property="building-mac">
		<equals arg1="${platform}" arg2="carbon-macosx"/>
	</condition>
	<condition property="building-linux">
		<or>
			<equals arg1="${platform}" arg2="gtk2-linux-x86"/>
			<equals arg1="${platform}" arg2="gtk2-linux-x86_64"/>
		</or>
	</condition>

	<property name="distName" value="${ant.project.name}_${platform}_${rainbowStamp}" />

	<echo message=" ------------------------------------------------------------${line.separator}
Distribution being built: ${platform}${line.separator}
Version info: ${rainbowStamp}${line.separator}
Running on: ${os.name} ${os.arch}${line.separator}
------------------------------------------------------------"/>

	<property name="proj_rainbow" value="../../applications/rainbow"/> 
	<property name="src_rainbow" value="${proj_rainbow}/src"/> 
	<property name="lib_rainbow" value="${proj_rainbow}/lib"/> 
	<property name="build" value="build"/>
 	<property name="tmp" value="tmp"/>
	<property name="dist" value="dist_${platform}"/>
	<property name="distlib" value="${dist}/lib"/>
 
	<path id="mainClassPath_rainbow">
		<pathelement location="${tmp}"/>
		<pathelement location="${distlib}/swt.jar"/>
		<pathelement location="${distlib}/h2.jar"/>
		<pathelement location="${distlib}/stax-api-1.0.1.jar"/>
	</path>

	<target name="init">
		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${tmp}"/>
			<fileset dir="${dist}"/>
		</delete>
		<mkdir dir="${tmp}"/>
		<mkdir dir="${distlib}"/>
 	</target>
 	
 	<target name="doLibs">
		<ant antfile="../shared/build_third-party.stax-wstx.xml" inheritAll="true"/>
		<copy file="../../third-party/${platform}/swt.jar" todir="${distlib}"/>
 	</target>
 	
 	<target name="winProjects" if="building-windows">
		<ant antfile="../shared/build_tm.trados.xml" inheritAll="true"/>
 	</target>
 	
	<target name="compile" depends="init, doLibs, winProjects"> 
		<copy todir="${tmp}/META-INF">
			<fileset dir="data" includes="**/*.txt"/>
		</copy>

		<ant antfile="../shared/build_common.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.common.xml" inheritAll="true"/>
		<ant antfile="../shared/build_pipeline.xml" inheritAll="true"/>
		<ant antfile="../shared/build_steps.common.xml" inheritAll="true"/>
		
		<ant antfile="../shared/build_filters.html.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.properties.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.po.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.regex.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.xml.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.xliff.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.idml.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.openoffice.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.openxml.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.rtf.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.tmx.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.mif.xml" inheritAll="true"/>
		<ant antfile="../shared/build_filters.dtd.xml" inheritAll="true"/>

		<ant antfile="../shared/build_lib.segmentation.xml" inheritAll="true"/>
		<ant antfile="../shared/build_mt.google.xml" inheritAll="true"/>
		<ant antfile="../shared/build_tm.simpletm.xml" inheritAll="true"/>

		<ant antfile="../shared/build_ui.common.xml" inheritAll="true"/>
		<ant antfile="../shared/build_ui.filters.common.xml" inheritAll="true"/>

		<ant antfile="../shared/build_ui.filters.properties.xml" inheritAll="true"/>
		<ant antfile="../shared/build_ui.filters.po.xml" inheritAll="true"/>
		<ant antfile="../shared/build_ui.filters.openoffice.xml" inheritAll="true"/>
		<ant antfile="../shared/build_ui.filters.regex.xml" inheritAll="true"/>

		<ant antfile="../shared/build_ui.lib.segmentation.xml" inheritAll="true"/>

 		<javac srcdir="${src_rainbow}" destdir="${tmp}" classpathref="mainClassPath_rainbow"/>
		<copy todir="${tmp}">
			<fileset dir="${src_rainbow}" excludes="**/*.java"/>
		</copy>
		<copy todir="${distlib}">
			<fileset dir="${lib_rainbow}"/>
		</copy>
		
		<copy todir="${dist}">
			<fileset dir="data/${platform}"/>
		</copy>

		<copy todir="${dist}/config">
			<fileset dir="../shared/config"/>
		</copy>

		<copy file="../../help/help.css" todir="${dist}/help"/>
		<copy file="../../help/filters/ui/index.html" todir="${dist}/help/filters/ui"/>
		<copy todir="${dist}/help/applications/rainbow">
			<fileset dir="../../help/applications/rainbow" excludes="**/*.psd" />
		</copy>

		<!-- DO NOT CHANGE WHITESPACES IN ATTRIBUTE VALUE 
		AND CHECK MANIFEST IN JAR IF YOU ADD/REMOVE JARs -->
		<manifest file="${tmp}/MANIFEST.MF">
			<attribute name="Main-Class" value="net.sf.okapi.applications.rainbow.Main"/>
			<attribute name="Implementation-Title" value="${ant.project.name}"/>
			<attribute name="Implementation-Version" value="${rainbowStamp}"/>
			<attribute name="Class-Path" value="swt.jar h2.jar stax-api-1.0.1.jar wstx-lgpl-3.2.8.jar    
jyaml-1.3.jar jericho-html-3.1-dev-5.jar dtdparser121.jar"/>
  		</manifest>

		<jar jarfile="${distlib}/${ant.project.name}.jar" basedir="${tmp}" manifest="${tmp}/MANIFEST.MF"
			excludes="MANIFEST.MF"
  		/>

		<copy todir="${dist}" file="data/readme.html"/>

		<delete includeEmptyDirs="true" failonerror="false">
			<fileset dir="${tmp}"/>
		</delete>

	</target>

	<target name="winExe" if="building-windows">
		<copy file="data/${platform}_nocopy/rainbow.exe" todir="${dist}"/>
	</target>
	
	<target name="zipAll" unless="building-linux">
		<zip destfile="${dist}/${distName}.zip" basedir="${dist}"/>
	</target>

	<target name="gzipAll" if="building-linux">
		<!--
		TODO: Here we copy the dist dir to a new dir to match the name of the tar file
		      we could build it directly into such a directory 
		-->
		<mkdir dir="${dist}/${distName}"/>
		<copy todir="${dist}/${distName}">
			<fileset dir="${dist}" excludes="${distName}"/>
		</copy>

		<tar destfile="${dist}/${distName}.tar.gz" compression="gzip">
			<tarfileset filemode="755" dir="${dist}">
				<include name="${distName}/**/*.sh"/>
			</tarfileset>
			<tarfileset dir="${dist}">
				<include name="${distName}/**/*"/>
				<exclude name="${distName}/**/*.sh"/>
			</tarfileset>
		</tar>
		
		<delete dir="${dist}/${distName}"/>
	</target>
	
	<target name="all" depends="compile, winExe, zipAll, gzipAll"/>

</project>
